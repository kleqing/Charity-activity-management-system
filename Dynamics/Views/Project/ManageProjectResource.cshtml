@model IEnumerable<Dynamics.Models.Models.ProjectResource>
@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json
@inject IHttpContextAccessor Accessor
@inject IProjectRepository ProjectRepository

<link rel="stylesheet" href="~/css/output.css">
<!-- Navbar -->
@{
    ViewData["Title"] = "Get All Resources";
    Layout = "~/Views/Shared/_LayoutProject.cshtml";
    var currentUserID = Accessor.HttpContext.Session.GetString("currentUserID");
    var currentProjectID = Accessor.HttpContext.Session.GetString("currentProjectID");
    var ProjectMemberOfUser = ProjectRepository.FilterProjectMember(p => p.ProjectID.Equals(new Guid(currentProjectID)) && p.UserID.Equals(new Guid(currentUserID)));
    var statusProjectMemberOfUser = ProjectMemberOfUser?.FirstOrDefault()?.Status;
    ProjectResource projectResource = new ProjectResource();
    projectResource.ProjectID = new Guid(currentProjectID);
}
<!-- container -->
<div class="m-w-screen-2xl flex flex-col items-center justify-center relative">
    <!-- title -->
    <h2 class="font-serif text-black font-bold text-3xl text-center my-6">Project resources</h2>
    <!-- PART 1 -->
    <!-- list resource -->
    <div class="flex flex-col relative w-3/4 gap-y-6 mb-10">
        @for(int i = 0 ; i < Model.Count();i++){
            var item = Model.ElementAt(i);
            <div id="resourceDiv-@item.ResourceID" class="grid grid-cols-4 gap-x-10 py-2 px-6 shadow-md shadow-blue-500/30 rounded-xl items-center">
            
            <div class="flex justify-start items-center ">
                <div class="text-left p-2 text-semibold text-xl text-gray-900">@(i+1).</div>
                <div class=" flex items-center">
                    <img class="rounded-full w-10 h-10 mx-4 "
                         src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ1t4JIwLRSPPY8XSRHwTedMXGTQd3Qn8J9IQ&s"
                         alt="avatar">
                </div>
                <div class="flex flex-col ">
                    <a class="text-black font-bold">@item.ResourceName</a>
                </div>
            </div>
            <div class="text-center">
                <p class="text-black font-semibold">@item.Unit</p>
            </div>
            <div class="text-center">
                <p class="text-black font-semibold">@item.Quantity/@item.ExpectedQuantity</p>
            </div>
            <div class="relative text-right flex justify-end pr-10 gap-x-4">
                    @if (item.Quantity < item.ExpectedQuantity ||item.ExpectedQuantity == null){
                        <button type="button"
                                class=" cursor-not-allowed h-10 text-white  bg-orange-500 hover:bg-orange-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2">
                            In
                            progress
                        </button>
                    }else
                    {
                        <button type="button"
                                class="cursor-not-allowed h-10 text-white  bg-green-500 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2">
                            Completed
                        </button>
                    }
                    @if (statusProjectMemberOfUser >= 2)
                    {
                        <button onclick="showEditForm('@item.ResourceID')" type="button" class="absolute w-fit h-fit mx-2 my-2 p-2" style="top:-18px; right:0px;">
                            <i class="fa-regular fa-pen-to-square text-xl text-gray-900"></i>
                            </button>
                            <a asp-action="DeleteResourceType" asp-route-resourceid="@item.ResourceID">
                        <button type="button" class="absolute w-fit h-fit mx-2 my-2 p-2" style="top:-18px; right:-33px;">
                            <i class="fa-solid fa-trash text-xl text-gray-900"></i>
                        </button>
                        </a>

                }
            </div>           
        </div>

            <!-- Hidden form to edit resource -->
            <div id="editForm-@item.ResourceID"
                 class="bg-white hidden grid grid-cols-2 gap-x-6 py-2 px-6 shadow-md shadow-blue-500/30 rounded-xl items-center">
                <form id="formUpdate"  asp-action="UpdateResourceType" method="post">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                    <!-- Explicitly referencing ProjectResource model -->
                    <input id="currentResourceID"type="hidden" name="ResourceID" value="@item.ResourceID" />
                    <input type="hidden" name="ProjectID" value="@item.ProjectID" />

                    <div class="grid grid-cols-3 gap-x-6 gap-y-3">
                        <div>
                            <label for="ResourceName" class="block mb-2 text-md font-medium text-gray-900">
                                Enter resource name
                            </label>
                            <input id="ResourceNameUpdateInput" readonly name="ResourceName" type="text" value="@item.ResourceName"
                                   class="bg-white border border-gray-300 text-navy-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                   required />
                            <span asp-validation-for="@item.ResourceName" class="text-danger"></span>
                        </div>
                        <div>
                            <label for="ExpectedQuantity" class="block mb-2 text-md font-medium text-gray-900">
                                Enter expected quantity
                            </label>
                            <input min="0" name="ExpectedQuantity" type="number" value="@item.ExpectedQuantity"
                                   class="bg-white border border-gray-300 text-navy-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                   required />
                            <span asp-validation-for="@item.ExpectedQuantity" class="text-error"></span>
                        </div>

                        <div>
                           
                            <label asp-for="@item.Unit" class="block mb-2 text-md font-medium text-gray-900">
                                Enter resource unit
                            </label>
                            <input id="UnitUpdateInput" name="Unit" type="text" asp-for="@item.Unit" 
                                   class="bg-white border border-gray-300 text-navy-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                                   required />
                            <span asp-validation-for="@item.Unit" class="text-error"></span>
                            <span id="unitUpdateError" class="text-error text-red-500 text-sm font-semibold "></span>
                        </div>
                    </div>

                    <div class="flex justify-center gap-x-6">
                        <button type="submit" id="updateResourceBtn" onclick="validateUpdateResource('@item.ResourceID')"
                                class="mt-4 text-md text-white bg-blue-800 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-bold rounded-lg w-full sm:w-auto px-5 py-2.5 text-center">
                            Update
                        </button>
                        <button onclick="cancelEditForm('@item.ResourceID')" type="reset"
                                class="mt-4 text-md text-white bg-blue-800 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-bold rounded-lg w-full sm:w-auto px-5 py-2.5 text-center">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>

        }
        <div class="h-36"></div>
    </div>

    <!-- pagination -->
    <nav aria-label="Page navigation example" class="my-6">
        <ul class="bg-white inline-flex -space-x-px text-md ">
            <li>
                <a href="#"
                   class="flex items-center justify-center px-3 h-8 ms-0 leading-tight text-gray-500 bg-white border border-e-0 border-gray-100 rounded-s-lg hover:bg-gray-100 hover:text-gray-700 ">
                    <span class="pr-2"><i class="fa-solid fa-arrow-left"></i></span>Previous
                </a>
            </li>
            <li>
                <a href="#"
                   class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-100 hover:bg-gray-100 hover:text-gray-700 ">1</a>
            </li>
            <li>
                <a href="#"
                   class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-100 hover:bg-gray-100 hover:text-gray-700 ">2</a>
            </li>
            <li>
                <a href="#" aria-current="page"
                   class="flex items-center justify-center px-3 h-8 text-blue-600 border border-gray-100 bg-blue-50 hover:bg-blue-100 hover:text-blue-700 ">3</a>
            </li>
            <li>
                <a href="#"
                   class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-100 hover:bg-gray-100 hover:text-gray-700 ">...</a>
            </li>
            <li>
                <a href="#"
                   class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-100 hover:bg-gray-100 hover:text-gray-700 ">10</a>
            </li>
            <li>
                <a href="#"
                   class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-100 hover:bg-gray-100 hover:text-gray-700 ">11</a>
            </li>
            <li>
                <a href="#"
                   class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-100 rounded-e-lg hover:bg-gray-100 hover:text-gray-700">
                    Next
                    <span class="pl-2"><i class="items-center fa-solid fa-arrow-right"></i></span>
                </a>
            </li>
        </ul>
    </nav>
</div>
@if (statusProjectMemberOfUser >= 2){
<div class="flex relative justify-center my-6 w-3/4 mx-auto">
    <!-- add button -->

        <button type="button"              
                class="h-14 text-white  bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-semibold rounded-lg text-xl px-4 py-2">
            Add resource
        </button>   
</div>
<!-- hide/show -->
<div  class="w-3/4 mx-auto flex-col shadow-lg shadow-blue-500/30 p-6 rounded-3xl my-10">
    <h2 class="font-serif text-black font-bold text-3xl text-center ">Add new resource</h2>
    <!-- form 1 -->
        <form id="formAdd"method="post" asp-action="AddProjectResourceType" asp-controller="Project" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="@projectResource.ProjectID" />
        <div class="grid grid-cols-3 gap-x-6 gap-y-3">
                <div>
                    <label asp-for="@projectResource.ResourceName" class="block mb-2 text-md font-medium text-gray-900">
                        Enter resource
                        name
                    </label>
                    <input id="ResourceNameInput" asp-for="@projectResource.ResourceName" type="text"
                           class="bg-white border border-gray-300 text-navy-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                           placeholder="Blanket" required />
                    <span asp-validation-for="@projectResource.ResourceName" class="text-error text-red-500 text-sm font-semibold"></span>
                </div>
            <div>
                    <label asp-for="@projectResource.ExpectedQuantity" class="block mb-2 text-md font-medium text-gray-900">
                    Enter
                    expected quantity
                </label>
                    <input min="0" asp-for="@projectResource.ExpectedQuantity" type="number"
                       class="bg-white border border-gray-300 text-navy-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                       placeholder="164" required />
                    <span asp-validation-for="@projectResource.ExpectedQuantity" class="text-error text-red-500 text-sm font-semibold"></span>
            </div>
            <div>
                    <label asp-for="@projectResource.Unit" class="block mb-2 text-md font-medium text-gray-900">
                    Enter expected
                    unit
                </label>
                    <input id="UnitInput" asp-for="@projectResource.Unit" type="text"
                       class="bg-white border border-gray-300 text-navy-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
                       placeholder="..." required />
                    <span asp-validation-for="@projectResource.Unit" class="text-error text-red-500 text-sm font-semibold"></span>
                    <span id="unitError" class="text-error text-red-500 text-sm font-semibold "></span>
            </div>
        </div>
        <div class="flex justify-center">
            <button type="button" id="addResourceBtn"
                    class="mt-4 text-md text-white bg-blue-800 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-bold rounded-lg w-full sm:w-auto px-5 py-2.5 text-center">
                Add
            </button>
        </div>
    </form>
</div>
 }
<!-- end container -->
<script>
    @* hide/showEditForm  *@
    function showEditForm(itemID) {
        console.log("Trying to show form for: resourceDiv-" + itemID);
        var resourceDiv = document.getElementById('resourceDiv-' + itemID);
        var editForm = document.getElementById('editForm-' + itemID);
        if (resourceDiv && editForm) {
            resourceDiv.style.display = 'none';  // Hide the original div
            editForm.style.display = 'block';  // Show the form
        } else {
            console.error("Element not found for itemID:", itemID);
        }
    }

    function cancelEditForm(itemID) {
        var resourceDiv = document.getElementById('resourceDiv-' + itemID);
        var editForm = document.getElementById('editForm-' + itemID);
        if (resourceDiv && editForm) {
            editForm.style.display = 'none';  // Hide the form
            resourceDiv.style.display = 'grid';  // Show the original div
        } else {
            console.error("Element not found for itemID:", itemID);
        }
    }

    @* --------------validate add resource------------------------------------------------- *@
            var existingResources = @Html.Raw(JsonConvert.SerializeObject(Model.ToList()));

        function validateResource() {
            console.log("validateResource function called"); // Debug log

            // Get values from inputs
            var resourceNameInput = document.getElementById('ResourceNameInput');
            var unitInput = document.getElementById('UnitInput');

            // Check if elements exist
            if (!resourceNameInput || !unitInput) {
                console.error("Required input elements not found");
                return false;
            }

            var resourceName = resourceNameInput.value.trim();
            var unit = unitInput.value.trim();

            console.log("Resource Name:", resourceName); // Debug log
            console.log("Unit:", unit); // Debug log

            // Error span elements
            var unitError = document.getElementById('unitError');

            if ( !unitError) {
                console.error("Error span elements not found");
                return false;
            }

            // Clear previous errors
            unitError.innerText = '';

            // Check for duplicates
            var duplicateFound = existingResources.some(function (resource) {
            console.log(`Comparing: ${resource.ResourceName} with ${resourceName} and ${resource.Unit} with ${unit}`);
            return resource.ResourceName.trim().toLowerCase() === resourceName.toLowerCase() &&
                resource.Unit.trim().toLowerCase() === unit.toLowerCase();
        });
        console.log("duplicateFound", duplicateFound);
        debugger;
            if (duplicateFound) {
                // Show error and clear input
               
                unitError.innerText = "A resource with the same unit already exists!";
                unitInput.value = '';
                return false;
        } else {
                // If validation passes, submit the form
            
                document.getElementById('formAdd').submit();
                return true;
            }
        }
        @* //validate update resource *@
      
    function validateUpdateResource(resourceIDvalue) {
        preventDefault();
        console.log("validateUpdateResource function called"); // Debug log

        // Get values from inputs
    
        var resourceNameUpdateInput = document.getElementById('ResourceNameUpdateInput');
        var unitUpdateInput = document.getElementById('UnitUpdateInput');
        
        // Check if elements exist
        if (!resourceNameUpdateInput || !unitUpdateInput) {
            console.error("Required input elements not found");
            return false;
        }

        var resourceName = resourceNameUpdateInput.value.trim();
        var unit = unitUpdateInput.value.trim();
     
         var existingUpdateResources = existingResources.filter(function (resource) {
        return resource.ResourceID != resourceIDvalue;
    });
        console.log("Resource ID:", resourceIDvalue); // Debug log
        console.log("Resource Name:", resourceName); // Debug log
        console.log("Unit:", unit); // Debug log
          console.log("existingUpdateResources", existingUpdateResources);
        
          // Error span elements
        var unitUpdateError = document.getElementById('unitUpdateError');
        if (!unitUpdateError) {
            console.error("Error span elements not found");
            return false;
        }
        unitUpdateError.innerText = '';
      
         debugger;
        // Check for duplicates
        var duplicateFound = existingUpdateResources.some(function (resource) {
                console.log(`Comparing: ${resource.ResourceName} with ${resourceName} and ${resource.Unit} with ${unit}`);
                return resource.ResourceName.trim().toLowerCase() === resourceName.toLowerCase() &&
                    resource.Unit.trim().toLowerCase() === unit.toLowerCase();
        });
            console.log("duplicateFound", duplicateFound);

         debugger;
        if (duplicateFound) {
            // Show error and clear input
             console.log( "YES! DUPLICATED!");
            unitUpdateError.innerText = "Resource with the same unit already exists!";
            unitInput.value = '';
            return false;
        } else {
            // If validation passes, submit the form
                console.log( "NO. NO DUPLICATE");
             document.getElementById('formUpdate').submit();
            return true;
        }
    }

    // Add event listener to the button
    document.addEventListener('DOMContentLoaded', function () {
        var addResourceBtn = document.getElementById('addResourceBtn');
        if (addResourceBtn) {
            addResourceBtn.addEventListener('click', function (event) {
                event.preventDefault(); // Prevent default form submission
                validateResource();
            });
        } else {
            console.error("Add Resource button not found");
        }

     @*     var updateResourceBtn = document.getElementById('updateResourceBtn');
         if (updateResourceBtn) {
             updateResourceBtn.addEventListener('click', function (event) {
                 event.preventDefault(); // Prevent default form submission
                    var currentResourceID = document.getElementById('currentResourceID');
                 var resourceIDvalue = currentResourceID.value.trim();
                 validateUpdateResource(resourceIDvalue);
             });
         } else {
             console.error("Update Resource button not found");
         } *@
    });
</script>



